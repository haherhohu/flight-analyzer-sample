name: AI Code Review

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  ai-review:
    name: AI-Powered Code Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Get changed files
        id: changed-files
        run: |
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt

      - name: Analyze code complexity
        run: |
          echo "ðŸ” Analyzing code complexity..."
          pip install radon

          # Get Python files from changed files
          grep '\.py$' changed_files.txt > python_files.txt || echo "No Python files changed"

          if [ -s python_files.txt ]; then
            echo "ðŸ“Š Complexity Analysis:"
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                echo "File: $file"
                radon cc "$file" -s || true
                radon mi "$file" -s || true
              fi
            done < python_files.txt
          fi

      - name: Check code patterns
        run: |
          echo "ðŸ”Ž Checking code patterns..."
          pip install pylint bandit

          if [ -s python_files.txt ]; then
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                echo "Analyzing: $file"
                
                # Run pylint
                pylint "$file" --disable=C0111 --output-format=json > "${file}_pylint.json" || true
                
                # Run bandit for security
                bandit "$file" -f json -o "${file}_bandit.json" || true
              fi
            done < python_files.txt
          fi

      - name: AI-based review suggestions
        run: |
          echo "ðŸ¤– Generating AI-based review suggestions..."

          # Initialize review summary
          cat > ai_review_summary.md << 'HEADER'
          # ðŸ¤– AI Code Review Summary

          ## Overview
          This PR has been automatically analyzed using AI and static analysis tools.

          HEADER

          # Add complexity analysis results
          echo "" >> ai_review_summary.md
          echo "## Code Quality Metrics" >> ai_review_summary.md
          echo "" >> ai_review_summary.md
          echo "### Complexity Analysis" >> ai_review_summary.md

          if [ -s python_files.txt ]; then
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                echo "#### \`$file\`" >> ai_review_summary.md
                echo '```' >> ai_review_summary.md
                radon cc "$file" -s 2>/dev/null || echo "No complexity data available" >> ai_review_summary.md
                echo '```' >> ai_review_summary.md
                
                # Maintainability Index
                MI=$(radon mi "$file" -s 2>/dev/null | grep -oP '\d+\.\d+' | head -1 || echo "N/A")
                if [ "$MI" != "N/A" ]; then
                  echo "**Maintainability Index:** $MI" >> ai_review_summary.md
                  
                  # Interpret MI score
                  MI_INT=$(echo $MI | cut -d'.' -f1)
                  if [ "$MI_INT" -ge 20 ]; then
                    echo "âœ… **Status:** Highly maintainable" >> ai_review_summary.md
                  elif [ "$MI_INT" -ge 10 ]; then
                    echo "âš ï¸ **Status:** Moderately maintainable" >> ai_review_summary.md
                  else
                    echo "âŒ **Status:** Difficult to maintain" >> ai_review_summary.md
                  fi
                fi
                echo "" >> ai_review_summary.md
              fi
            done < python_files.txt
          else
            echo "No Python files changed in this PR." >> ai_review_summary.md
          fi

          # Add security analysis results
          echo "" >> ai_review_summary.md
          echo "### Security Analysis" >> ai_review_summary.md
          echo "" >> ai_review_summary.md

          SECURITY_ISSUES=0
          if [ -s python_files.txt ]; then
            while IFS= read -r file; do
              if [ -f "${file}_bandit.json" ]; then
                ISSUES=$(jq '.results | length' "${file}_bandit.json" 2>/dev/null || echo "0")
                SECURITY_ISSUES=$((SECURITY_ISSUES + ISSUES))
                
                if [ "$ISSUES" -gt 0 ]; then
                  echo "#### âš ï¸ \`$file\`" >> ai_review_summary.md
                  echo "Found $ISSUES potential security issue(s):" >> ai_review_summary.md
                  echo '```json' >> ai_review_summary.md
                  jq '.results[] | {severity, confidence, issue_text, line_number}' "${file}_bandit.json" 2>/dev/null >> ai_review_summary.md
                  echo '```' >> ai_review_summary.md
                  echo "" >> ai_review_summary.md
                fi
              fi
            done < python_files.txt
          fi

          if [ "$SECURITY_ISSUES" -eq 0 ]; then
            echo "âœ… No security vulnerabilities detected by Bandit" >> ai_review_summary.md
          else
            echo "âš ï¸ **Total security issues found:** $SECURITY_ISSUES" >> ai_review_summary.md
          fi

          # Add code quality recommendations
          cat >> ai_review_summary.md << 'FOOTER'

          ## Recommendations

          ### Best Practices
          - âœ… Ensure all functions have comprehensive docstrings
          - âœ… Use type hints for better code clarity
          - âœ… Keep functions small and focused (single responsibility)
          - âœ… Write unit tests for new functionality

          ### Security Considerations
          - ðŸ”’ Validate all user inputs
          - ðŸ”’ Avoid hardcoding credentials
          - ðŸ”’ Use parameterized queries for database operations
          - ðŸ”’ Implement proper error handling

          ### Performance Tips
          - âš¡ Profile code for bottlenecks
          - âš¡ Consider caching frequently accessed data
          - âš¡ Use appropriate data structures
          - âš¡ Optimize database queries

          ---

          *This review was generated automatically using static analysis tools (Radon, Bandit, Pylint).*

          **Note**: Automated reviews complement but do not replace human code review.
          FOOTER

          echo ""
          echo "ðŸ“„ Review summary generated:"
          cat ai_review_summary.md

      - name: Post AI review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comment = '';

            try {
              comment = fs.readFileSync('ai_review_summary.md', 'utf8');
            } catch (error) {
              comment = '## ðŸ¤– AI Code Review\n\nAI review could not be completed. Please review manually.';
            }

            // Check if there's already a comment from this workflow
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸ¤– AI Code Review')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Upload analysis artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-review-artifacts
          path: |
            changed_files.txt
            python_files.txt
            *_pylint.json
            *_bandit.json
            ai_review_summary.md
